# -*- coding: utf-8 -*-
#!/usr/bin/env python

import sys
from scrapy.spider import BaseSpider
from scrapy.selector import Selector
from scrapy.utils.url import urljoin_rfc
from scrapy.http import Request
from chebaba.items import AutohomePriceItem

def filt(string, start, end):
    i = string.find(start) + len(start)
    j = string[i:].find(end)
    return string[i : i + j]

class AutohomePriceSpider(BaseSpider):
    name = 'autohomeprice'
    allowed_domains = ['http://dealer.autohome.com.cn/']
    dealers = [79501,7508,66490,2004624,66981,1694,73902,2812,71135,2015469,121912,9047,102160,7518,8793,78857,2108,71504,103737,70285,8805,7494,66679,77349,81906,120429,126673,64024,65864,103745,121544,72639,104065,66498,79414,8654,118392,125078,104117,117226,79954,118975,2820,82149,8716,76578,66458,83774,8698,85685,7515,1733,120973,8699,103414,130435,8798,8788,65924,73406,11051,2016397,60290,76664,2018182,125113,61990,83489,78046,11615,66983,8662,82659,8452,125857,2016479,79234,66675,8453,8707,15499,62774,7486,103374,8725,3493,2695,7538,125112,7478,2016397,119849,15878,85698,8735,65716,3698,15772,126847,12875,77460,8787,107535,1735,7522,8451,15675,76343,69077,1188,11063,2697,72633,77754,69737,8691,8731,15744,4205,81558,101097,8638,71257,61482,121260,125062,64193,8666,73715,62829,4774,75876,7513,5038,103217,68136,8744,125108,2018181,119848,8796,78110,2802,79947,65844,118623,85545,2016030,85765,69,72475,7504,2017129,85910,122539,3496,7532,75800,4879,65874,60113,72782,2396,97540,61480,2800,65876,72488,8754,97623,2403,7516,125922,2004015,97548,7496,11486,79959,12130,65861,8438,78828,84431,3498,64,68845,8726,1500,129330,2248,99060,7529,13094,2401,65846,66811,15793,66513,8803,8797,65720,120716,2016705,119847,79942,13269,13138,84955,5656,79949,121625,79063,7489,2016453,66993,15498,2816,121523,8443,8014,8447,65879,74627,8448,15888,14963,60241,125700,65872,128988,4204,82843,13178,11841,83717,82100,73195,65922,2015717,3349,102039,60050,66493,2006527,66991,103393,125107,5652,112959,104075,7540,13133,2001970,65839,2003303,76368,125086,8768,126089,129813,8792,100453,64283,122994,5655,97611,72509,13128,72473,7512,8720,7510,2394,2824,2016704,2016023,8719,103417,105361,101992,1192,66976,2015771,98979,2825,1265,2821,64458,7485,7519,2017110,4660,2696,11770,66483,100280,2003639,72777,97682,8751,8646,79955,2016024,123501,2017111,120290,79943,97641,7490,66810,77482,120659,73184,2003713,3505,2817,1837,8446,65923,79896,62040,8742,3920,3503,13080,125101,83361,100282,104076,124172,103399,85111,2397,97542,65857,7503,104072,72636,85354,79935,79941,1497,1263,8444,7477,1734,2017108,77614,3490,7509,83249,120107,3891,82876,79707,8750,1836,7517,7475,103369,117222,99735,4206,97539,12665,994,370,8696,7514,61481,65869,72490,984,7499,78162,125106,4965,81965,2016702,81889,12844,66685,121987,123676,85731,72486,7511,1266,104635,3497,61219,121912,7497,78586,126845,8736,7537,3504,7502,13210,2002710,72691,4207,81950,2116,3853,79513,1732,117227,2003193,78826,72641,125109,112448,7528,7498,7530,65845,62169,13163,66673,2016037,66447,125766,72657,119057,123082,2819,79956,118390,66869,77490,79568,85211,120338,65838,81862,66990,72261,104061,8713,7479,4208,66950,125105,14966,8763,378,7549,72547,7507,102088,66940,119791,2016022,60175,100966,8714,2813,3506,107579,104463,7487,87910,1736,123897,8746,2247,13247,70629,78056,79319,8785,79922,8794,81948,8814,8728,6377,72648,7501,8695,8732,84411,66502,7505,8802,66510,2402,8743,12763,60201,79878,126222,98125,125825,2002792,82981,100385,129195,120315,79945,66847,86040,125076,79946,130146,8782,66670,8775,7543,103112,66677,75557,79968,61844,99841,85011,125040,104074,66465,8745,119153,79106,11496,2006422,125429,2018180,2016042,102301,2018183,120286,7482,127474,77491,12770,112466,102064,65849,2016019,129261,2016132,2815,121085,75906,66809,2001673,79088,83269,122393,2002794,66812,75909,2822,103734,8810,125022,101405,75208,8661,122927,120529,66477,75127,74492,2016502,101947,65848,66859,101675,125110,77489,8209,75837,8693,77156,118632,8467,75885,83545,80443,2017096,101611,102140,110372,124631,79953,2016492,65850,103669,2017528,13264,78843,79944,8765,2016503,65517,64669,82068,8652,72703,78019,7539,118430,124321,66860,8667,7531,101988,73397,66686,99197,117519,2016486,8664,2016515,104939,66489,66668,122776,14051,8700,83086,103743,125615,7544,119609,65878,7535,2400,66850,7495,8663,126186,116491,125115,3495,111074,66998,124368,86253,2811,103385,7493,2814,101391,103404,2016034,103396,3501,72655,8708,125510,72692,9194,2016489,102479,2004883,999,8648,77485,13111,2016491,1693,72652,126849,3500,66878,66511,115527,77488,2002793,61718,72763,2818,66858,2006423,130110,77483,129209,130111,120914,120379,82006,8737,129015,8757,2017632,119594,103416,73408,2016035,2016021,8815,8721,66463,8722,72535,103420,103392,2016703,67665,115133,8808,3494,79277,3491,2017109,125114,7542,124353]
    brands = [522, 2381, 2086, 656, 425, 634, 564, 448, 64, 438, 702, 436, 264]
    urls = []
    for dealer in dealers:
        for brand in brands:
            urls.append('http://dealer.autohome.com.cn/' + str(dealer) + '/b_' + str(brand) + '.html')
    start_urls = urls

    def parse(self, response):
        sel = Selector(response)
        trs = sel.xpath('//table[@class="list-table"]/tr')
        if not trs: return  # no specified model
        item = AutohomePriceItem()
        item['dealer'] = sel.xpath('//div[@class="text-main"]/text()').extract()[0]
        item['dealerid'] = sel.xpath('//li[@id="nav_0"]/a/@href').extract()[0].replace('/', '')
        item['brand'] = sel.xpath('//p[@class="name-text font-yh"]/a/text()').extract()[0]
        item['brandid'] = filt(sel.xpath('//p[@class="name-text font-yh"]/a/@href').extract()[0], 'cn/', '/')
        items = []
        for tr in trs:
            tmp = tr.xpath('td[2]/p/text()').extract()
            if not tmp: continue  # filt th row
            else: item['oprice'] = tmp[0]
            item['oprice'] = item['oprice'].replace(u'万','')
            tmp = tr.xpath('td[3]/div[@class="this-number red"]/a[1]/text()').extract()
            if not tmp: tmp = tr.xpath('td[3]/p/a/text()').extract()
            item['price'] = tmp[0].replace(u'万','')
            tmp = tr.xpath('td[1]/a/text()').extract()[0]
            item['model'] = tmp[:tmp.find('<')]
            item['modelid'] = filt(tr.xpath('td[1]/a/@href').extract()[0], 'spec_', '.')
            items.append(item)
        return items
